#!/usr/bin/env python3
import sys, re, subprocess
from PyQt6.QtWidgets import (QApplication, QSystemTrayIcon, QDialog,
                             QVBoxLayout, QSlider, QLabel, QMessageBox, QMenu, QStyle)
from PyQt6.QtCore import Qt, QTimer
from PyQt6.QtGui import QIcon, QKeySequence, QShortcut, QAction

class SimpleBrightnessSlider(QDialog):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Monitor Brightness")
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint |
                           Qt.WindowType.WindowStaysOnTopHint)

        self.setFixedSize(300, 100)
        self.auto_close_timer = QTimer(self)
        self.auto_close_timer.setSingleShot(True)
        self.auto_close_timer.timeout.connect(self.close)

        layout = QVBoxLayout()
        layout.setContentsMargins(20, 20, 20, 20)

        self.label = QLabel("Brightness Slider")
        self.label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.label.setStyleSheet("font-weight: bold;")
        layout.addWidget(self.label)

        self.slider = QSlider(Qt.Orientation.Horizontal)
        self.slider.setRange(0, 100)
        self.slider.setValue(100)
        self.slider.setTickPosition(QSlider.TickPosition.TicksBelow)
        self.slider.setTickInterval(10)
        self.slider.setSingleStep(5)    # Arrow keys move 5%
        self.slider.setPageStep(20)     # Page up/down moves 20%
        self.slider.valueChanged.connect(self.on_slider_changed)
        layout.addWidget(self.slider)

        self.setLayout(layout)

        # Close with ESC
        QShortcut(QKeySequence("Escape"), self).activated.connect(self.close)

        self.timer = QTimer()
        self.timer.setSingleShot(True)
        self.timer.timeout.connect(self.apply_brightness)

    def on_slider_changed(self, value):
        self.label.setText(f"{value}%")

        # Debounce the brightness changes
        self.current_value = value
        self.timer.start(40)  # Apply after 40ms of no changes
        self.auto_close_timer.start(1500)

    def apply_brightness(self):
        try:
            subprocess.run(["ddcutil", "--display", "1","setvcp", "10", str(self.current_value)],
                         capture_output=True, timeout=1)
        except:
            pass  # Silently fail

class TrayApp():
    def __init__(self):
        self.app = QApplication(sys.argv)
        self.app.setQuitOnLastWindowClosed(False)

        self.tray = QSystemTrayIcon()
        self.tray.setIcon(QIcon.fromTheme("display-brightness"))
        self.tray.setToolTip("Adjust monitor brightness")
        self.tray.activated.connect(self.on_tray_clicked)

        self.slider = SimpleBrightnessSlider()

        # Create context menu
        self.menu = QMenu()

        self.menu.addAction("Show", lambda: self.slider_dialog.show())
        self.menu.addSeparator()
        self.menu.addAction(" Min", lambda: self.set_and_apply(0))
        self.menu.addAction(" 25%", lambda: self.set_and_apply(25))
        self.menu.addAction(" 50%", lambda: self.set_and_apply(50))
        self.menu.addAction(" 75%", lambda: self.set_and_apply(75))
        self.menu.addAction(" Max", lambda: self.set_and_apply(100))
        self.menu.addSeparator()
        self.menu.addAction("Quit", self.app.quit)

        self.tray.setContextMenu(self.menu)

        self.slider_dialog = SimpleBrightnessSlider()

        QTimer.singleShot(500, self.load_current_brightness)

    def set_and_apply(self, value):
        self.slider.current_value = value
        self.slider.apply_brightness()
        QTimer.singleShot(500, self.load_current_brightness)

    def load_current_brightness(self):
        try:
            result = subprocess.run(
                ["ddcutil", "getvcp", "10"],
                capture_output=True,
                text=True,
                timeout=1,
                check=True
                )

            match = re.search(r"current value\s*=\s*(\d+)", result.stdout)
            if match:
                current_brightness = int(match.group(1))
                print("Current brightness:", current_brightness)
                self.slider_dialog.slider.setValue(current_brightness)
            else:
                print("Could not parse brightness value")

        except:
            pass  # Ignore errors

    def on_tray_clicked(self, reason):
        if reason == QSystemTrayIcon.ActivationReason.Trigger:
            self.slider_dialog.show()
            self.slider_dialog.raise_()

    def run(self):
        self.tray.show()
        self.slider_dialog.show()

        return self.app.exec()

if __name__ == "__main__":
    # Check for ddcutil
    try:
        subprocess.run(
            ["ddcutil", "--version"],
            check=True,
            capture_output=True
        )
    except Exception:
        app = QApplication(sys.argv)
        QMessageBox.warning(
            None,
            "Brightness Slider",
            "ddcutil is not installed on this system."
        )
        sys.exit(1)

    result = subprocess.run(
        ["ddcutil", "detect"],
        capture_output=True,
        text=True,
        timeout=3
    )

    if "Display" not in result.stdout:
        app = QApplication(sys.argv)
        QMessageBox.information(
            None,
            "Brightness Slider",
            "No DDC-capable external monitor was detected."
        )
        sys.exit(1)

    app = TrayApp()
    sys.exit(app.run())
